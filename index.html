<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lecteur vid√©o local ‚Äî Sans compte</title>
<style>
  :root{
    --bg:#0b0f13;
    --card:#0f1720;
    --muted:#9aa6b2;
    --accent:#ef4444; /* rouge upload */
    --white:#ffffff;
    --radius:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    background:linear-gradient(180deg,var(--bg),#071014 120%);
    color:var(--white);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:24px;
  }

  /* Layout */
  .app{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 340px;gap:20px;align-items:start}
  header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
  .logo{
    width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#1f2937,#111827);
    display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--white);
    box-shadow:0 6px 18px rgba(0,0,0,.6);
  }
  h1{margin:0;font-size:1.25rem}
  .subtitle{color:var(--muted);font-size:0.9rem;margin-top:6px}

  /* Main column cards */
  .card{background:linear-gradient(180deg,var(--card),#071018);border-radius:var(--radius);padding:16px;box-shadow:0 8px 30px rgba(2,6,23,.6);border:1px solid rgba(255,255,255,0.03)}
  .controls{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .tabs{display:flex;gap:8px}
  .tab{padding:8px 12px;border-radius:999px;background:transparent;border:1px solid rgba(255,255,255,0.04);cursor:pointer;color:var(--muted);font-size:0.9rem}
  .tab.active{background:rgba(255,255,255,0.04);color:var(--white);border-color:rgba(255,255,255,0.06)}

  /* video list */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .video-card{background:linear-gradient(180deg,#071018,#0b1116);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:8px}
  .thumb{background:#000;border-radius:8px;height:130px;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
  .thumb video{width:100%;height:100%;object-fit:cover;filter:brightness(.9)}
  .meta{font-size:0.9rem}
  .meta h3{margin:0;font-size:0.95rem}
  .meta p{margin:4px 0 0;color:var(--muted);font-size:0.85rem;height:2.2em;overflow:hidden}
  .row{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px 10px;border-radius:8px;color:var(--muted);cursor:pointer;font-size:0.85rem}
  .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);cursor:pointer}

  /* right column */
  aside .card{position:sticky;top:24px}
  .small{font-size:0.85rem;color:var(--muted)}

  /* Floating upload button */
  .upload-fab{
    position:fixed;right:22px;bottom:22px;width:64px;height:64px;border-radius:50%;
    background:var(--accent);display:flex;align-items:center;justify-content:center;color:var(--white);
    box-shadow:0 12px 30px rgba(239,68,68,0.25);cursor:pointer;border:4px solid rgba(255,255,255,0.03);z-index:9999;
  }
  .upload-fab:hover{transform:translateY(-3px);transition:transform .14s ease}

  /* modal */
  .modal-back{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:flex;align-items:center;justify-content:center;z-index:10000}
  .modal{width:min(720px,96%);border-radius:12px;padding:18px;background:linear-gradient(180deg,#071018,#0b1116);border:1px solid rgba(255,255,255,0.03)}
  label{display:block;margin-bottom:6px;font-size:0.85rem;color:var(--muted)}
  input[type="text"], textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--white);outline:none;font-size:0.95rem}
  textarea{resize:vertical;min-height:90px}
  .form-row{display:flex;gap:8px}
  .muted{color:var(--muted);font-size:0.85rem}

  /* video player overlay */
  .player-overlay{position:fixed;inset:0;background:rgba(2,6,23,0.85);display:flex;align-items:center;justify-content:center;z-index:10001;padding:20px}
  .player-box{width:min(1100px,98%);max-height:86vh;border-radius:12px;background:#071018;padding:12px}
  .player-meta{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:8px}

  /* responsive */
  @media (max-width:980px){
    .app{grid-template-columns:1fr; padding-bottom:90px}
    aside{order:2}
  }
</style>
</head>
<body>
  <header>
    <div class="logo">v</div>
    <div>
      <h1>Lecteur local</h1>
      <div class="subtitle">Uploader et regarder des vid√©os sans compte ‚Äî stockage local (IndexedDB)</div>
    </div>
  </header>

  <div class="app">
    <main>
      <section class="card">
        <div class="controls">
          <div class="tabs" role="tablist" aria-label="Sections">
            <button class="tab active" data-tab="most">Les plus vues</button>
            <button class="tab" data-tab="fav">Favoris</button>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="small" id="count-videos">0 vid√©os</div>
            <button class="btn" id="clear-all">Vider tout</button>
          </div>
        </div>

        <div id="content">
          <!-- grid inserted here -->
          <div class="grid" id="videos-grid"></div>
        </div>
      </section>
    </main>

    <aside>
      <div class="card">
        <h3>Infos</h3>
        <p class="small">Upload via le bouton rouge en bas √† droite. Aucune connexion demand√©e. Les vid√©os restent sur cet appareil/navigateur.</p>
        <hr style="opacity:.06;margin:12px 0">
        <div>
          <div class="small">T√©moignage technique</div>
          <p class="muted">La base utilise IndexedDB pour stocker blobs vid√©o et m√©tadonn√©es. Attends quelques secondes apr√®s upload pour traitement.</p>
        </div>
        <hr style="opacity:.06;margin:12px 0">
        <div class="small">Raccourcis</div>
        <p class="muted">Cliquer sur une miniature ouvre le lecteur et incr√©mente les vues.</p>
      </div>
    </aside>
  </div>

  <!-- Floating upload button -->
  <div class="upload-fab" id="fab" title="Uploader une vid√©o" aria-label="Uploader une vid√©o">
    <!-- simple upload icon (cloud + arrow) -->
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden>
      <path d="M12 3v10" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M8 7l4-4 4 4" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M20 16.5A4.5 4.5 0 0 0 15.5 12H9.5A3.5 3.5 0 0 0 6 15.5v.5" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </div>

  <!-- hidden file input -->
  <input type="file" id="file-input" accept="video/*" style="display:none" />

  <!-- Upload modal -->
  <div id="modal-root" style="display:none"></div>

  <!-- player overlay -->
  <div id="player-root" style="display:none"></div>

<script>
/*
  Mini application: stocke les vid√©os dans IndexedDB (store = 'videos').
  Objet stock√©:
  {
    id: <auto>,
    title: string,
    desc: string,
    blob: Blob (video),
    views: number,
    favorite: boolean,
    createdAt: number
  }
*/

const DB_NAME = 'videos-db-v1';
const STORE_NAME = 'videos';
let db = null;

/* ---------- IndexedDB utils ---------- */
function openDB(){
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = e => {
      const idb = e.target.result;
      if(!idb.objectStoreNames.contains(STORE_NAME)){
        const store = idb.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
        store.createIndex('views', 'views', { unique: false });
        store.createIndex('favorite', 'favorite', { unique: false });
        store.createIndex('createdAt','createdAt',{unique:false});
      }
    };
    req.onsuccess = e => { db = e.target.result; resolve(db); };
    req.onerror = e => reject(e.target.error);
  });
}

function tx(storeName, mode='readonly'){
  const t = db.transaction(storeName, mode);
  return t.objectStore(storeName);
}

function addVideoToDB(obj){
  return new Promise((resolve,reject)=>{
    const store = tx(STORE_NAME,'readwrite');
    const req = store.add(obj);
    req.onsuccess = e => resolve(e.target.result);
    req.onerror = e => reject(e.target.error);
  });
}

function getAllVideos(){
  return new Promise((resolve,reject)=>{
    const store = tx(STORE_NAME,'readonly');
    const req = store.getAll();
    req.onsuccess = e => resolve(e.target.result);
    req.onerror = e => reject(e.target.error);
  });
}

function updateVideo(v){
  return new Promise((resolve,reject)=>{
    const store = tx(STORE_NAME,'readwrite');
    const req = store.put(v);
    req.onsuccess = e => resolve(e.target.result);
    req.onerror = e => reject(e.target.error);
  });
}

function deleteVideo(id){
  return new Promise((resolve,reject)=>{
    const store = tx(STORE_NAME,'readwrite');
    const req = store.delete(id);
    req.onsuccess = () => resolve();
    req.onerror = e => reject(e.target.error);
  });
}

function clearAll(){
  return new Promise((resolve,reject)=>{
    const store = tx(STORE_NAME,'readwrite');
    const req = store.clear();
    req.onsuccess = ()=> resolve();
    req.onerror = e=> reject(e.target.error);
  });
}

/* ---------- UI / behaviour ---------- */

const fab = document.getElementById('fab');
const fileInput = document.getElementById('file-input');
const modalRoot = document.getElementById('modal-root');
const playerRoot = document.getElementById('player-root');
const videosGrid = document.getElementById('videos-grid');
const countVideos = document.getElementById('count-videos');
const clearBtn = document.getElementById('clear-all');
const tabs = document.querySelectorAll('.tab');

let currentTab = 'most'; // 'most' or 'fav'

fab.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', handleFiles);
clearBtn.addEventListener('click', async ()=> {
  if(confirm('Vider toutes les vid√©os stock√©es localement ?')) {
    await clearAll();
    render();
  }
});

tabs.forEach(t => {
  t.addEventListener('click', ()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    currentTab = t.getAttribute('data-tab');
    render();
  });
});

/* show modal for title/description after file picked */
async function handleFiles(e){
  const file = e.target.files[0];
  if(!file) return;
  // limit: check type
  if(!file.type.startsWith('video/')){
    alert('S√©lectionne un fichier vid√©o.');
    return;
  }
  // create modal
  showUploadModal(file);
  fileInput.value = '';
}

function showUploadModal(file){
  modalRoot.innerHTML = `
    <div class="modal-back" id="modal-back">
      <div class="modal" role="dialog" aria-modal="true" aria-label="Upload vid√©o">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <strong>Uploader une vid√©o</strong>
          <button id="close-modal" class="icon-btn" title="fermer">‚úï</button>
        </div>
        <label>Titre</label>
        <input id="in-title" type="text" placeholder="Titre de la vid√©o (ex: Vacances)"/>
        <label style="margin-top:10px">Description</label>
        <textarea id="in-desc" placeholder="Description (optionnelle)"></textarea>
        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
          <div class="muted">Fichier: <strong style="color:var(--white)">${escapeHtml(file.name)}</strong></div>
          <div style="margin-left:auto" class="small muted">Taille: ${formatBytes(file.size)}</div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="cancel-upload" class="btn">Annuler</button>
          <button id="confirm-upload" class="btn" style="background:var(--accent);border-color:rgba(255,255,255,.04);color:white">Uploader</button>
        </div>
      </div>
    </div>
  `;
  modalRoot.style.display = 'block';
  document.getElementById('close-modal').onclick = closeModal;
  document.getElementById('cancel-upload').onclick = closeModal;
  document.getElementById('confirm-upload').onclick = async ()=>{
    const title = document.getElementById('in-title').value.trim() || file.name;
    const desc = document.getElementById('in-desc').value.trim() || '';
    // store blob and metadata to IDB
    try {
      await addVideoToDB({
        title,
        desc,
        blob: file,
        views: 0,
        favorite: false,
        createdAt: Date.now()
      });
      closeModal();
      render();
    } catch(err){
      alert('Erreur lors de l\'enregistrement : ' + err);
    }
  };
}

function closeModal(){
  modalRoot.innerHTML = '';
  modalRoot.style.display = 'none';
}

/* render list based on currentTab */
async function render(){
  const all = await getAllVideos();
  countVideos.textContent = `${all.length} vid√©o${all.length>1?'s':''}`;
  let list = [];
  if(currentTab === 'most'){
    list = all.sort((a,b)=> (b.views||0) - (a.views||0));
  } else {
    list = all.filter(v=>v.favorite).sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
  }

  if(list.length === 0){
    videosGrid.innerHTML = `<div style="grid-column:1/-1;padding:22px;color:var(--muted)">Aucune vid√©o ici. Utilise le bouton rouge en bas √† droite pour uploader une vid√©o.</div>`;
    return;
  }

  videosGrid.innerHTML = '';
  for(const v of list){
    const el = document.createElement('article');
    el.className = 'video-card';
    const url = URL.createObjectURL(v.blob);
    el.innerHTML = `
      <div class="thumb" data-id="${v.id}" tabindex="0" role="button" aria-pressed="false">
        <video src="${url}" preload="metadata" muted playsinline></video>
      </div>
      <div class="meta">
        <h3>${escapeHtml(v.title)}</h3>
        <p>${escapeHtml(v.desc)}</p>
        <div class="row" style="margin-top:6px">
          <div style="display:flex;gap:8px;align-items:center">
            <div class="small">${v.views||0} vues</div>
            <div class="small">${new Date(v.createdAt).toLocaleString()}</div>
          </div>
          <div style="display:flex;gap:6px;align-items:center">
            <button class="icon-btn fav-btn" title="Favori" data-id="${v.id}">${v.favorite? '‚òÖ' : '‚òÜ'}</button>
            <button class="icon-btn play-btn" title="Ouvrir" data-id="${v.id}">‚ñ∂</button>
            <button class="icon-btn del-btn" title="Supprimer" data-id="${v.id}">üóë</button>
          </div>
        </div>
      </div>
    `;
    // attach events
    el.querySelector('.thumb').addEventListener('click', ()=> openPlayer(v.id));
    el.querySelector('.thumb').addEventListener('keydown', (e)=> { if(e.key==='Enter') openPlayer(v.id) });
    el.querySelector('.play-btn').addEventListener('click', ()=> openPlayer(v.id));
    el.querySelector('.fav-btn').addEventListener('click', async (ev)=>{
      ev.stopPropagation();
      v.favorite = !v.favorite;
      await updateVideo(v);
      render();
    });
    el.querySelector('.del-btn').addEventListener('click', async (ev)=>{
      ev.stopPropagation();
      if(confirm('Supprimer cette vid√©o d√©finitivement ?')){
        await deleteVideo(v.id);
        render();
      }
    });

    videosGrid.appendChild(el);
  }
}

/* player overlay */
async function openPlayer(id){
  const store = tx(STORE_NAME,'readonly');
  const getReq = store.get(id);
  getReq.onsuccess = async (e) => {
    const v = e.target.result;
    if(!v) return;
    // create overlay
    const url = URL.createObjectURL(v.blob);
    playerRoot.style.display = 'block';
    playerRoot.innerHTML = `
      <div class="player-overlay" id="player-overlay">
        <div class="player-box card">
          <video id="player-video" src="${url}" controls autoplay style="width:100%;max-height:70vh;border-radius:8px;display:block;background:black"></video>
          <div class="player-meta">
            <div>
              <strong style="font-size:1.05rem">${escapeHtml(v.title)}</strong>
              <div class="small muted" style="margin-top:6px">${escapeHtml(v.desc)}</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <div class="small">${v.views||0} vues</div>
              <button id="fav-toggle" class="btn">${v.favorite? 'Retirer favori' : 'Ajouter favori'}</button>
              <button id="close-player" class="btn">Fermer</button>
            </div>
          </div>
        </div>
      </div>
    `;

    // increment views when user plays for >1 second
    const videoEl = document.getElementById('player-video');
    let counted = false;
    function tryCount(){
      if(counted) return;
      if(videoEl.currentTime > 1){
        counted = true;
        v.views = (v.views||0) + 1;
        updateVideo(v).then(()=>render());
      }
    }
    videoEl.addEventListener('timeupdate', tryCount);
    videoEl.addEventListener('playing', ()=> {
      // fallback
      setTimeout(tryCount, 1200);
    });

    document.getElementById('close-player').onclick = () => {
      playerRoot.style.display = 'none';
      playerRoot.innerHTML = '';
      URL.revokeObjectURL(url);
    };
    document.getElementById('fav-toggle').onclick = async () => {
      v.favorite = !v.favorite;
      await updateVideo(v);
      document.getElementById('fav-toggle').textContent = v.favorite? 'Retirer favori' : 'Ajouter favori';
      render();
    };
  };
  getReq.onerror = ()=>{};
}

/* small helpers */
function formatBytes(bytes){
  if(bytes<1024) return bytes + ' B';
  const kb = bytes/1024;
  if(kb<1024) return kb.toFixed(1)+' KB';
  const mb = kb/1024;
  if(mb<1024) return mb.toFixed(1)+' MB';
  return (mb/1024).toFixed(2) + ' GB';
}

function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* init DB and render */
(async function init(){
  try{
    await openDB();
    render();
  }catch(e){
    console.error('Erreur IndexedDB: ', e);
    alert('Impossible d\'initialiser le stockage local (IndexedDB). V√©rifie ton navigateur.');
  }
})();

/* small keyboard shortcut: U launches file picker */
document.addEventListener('keydown', (e) => {
  if(e.key.toLowerCase() === 'u' && !e.metaKey && !e.ctrlKey && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA'){
    fileInput.click();
  }
});
</script>
</body>
</html>
