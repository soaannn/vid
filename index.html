<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Soan</title>
<style>
  body {
    margin: 0;
    background: #121212;
    color: #fff;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
  }
  .soan-container {
    position: relative;
    font-size: 3rem;
    font-weight: 900;
    color: #ffdd00;
    text-transform: uppercase;
    letter-spacing: 0.3em;
    margin: 1rem 0 2rem;
  }
  .stars {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 200%;
    height: 200%;
    pointer-events: none;
    transform: translate(-50%, -50%);
    z-index: -1;
  }
  .star {
    position: absolute;
    color: #fff;
    font-size: 1.2rem;
    animation: twinkle 3s infinite ease-in-out;
    filter: drop-shadow(0 0 3px #fff);
  }
  .star:nth-child(1) { top: 10%; left: 20%; animation-delay: 0s; }
  .star:nth-child(2) { top: 30%; left: 70%; animation-delay: 1s; }
  .star:nth-child(3) { top: 60%; left: 50%; animation-delay: 2s; }
  .star:nth-child(4) { top: 75%; left: 15%; animation-delay: 1.5s; }
  .star:nth-child(5) { top: 40%; left: 80%; animation-delay: 0.7s; }
  @keyframes twinkle {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }
  .upload-btn {
    background: #ff0000;
    color: white;
    font-size: 2rem;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: fixed;
    bottom: 20px;
    right: 20px;
    box-shadow: 0 4px 10px rgba(255,0,0,0.6);
    z-index: 100;
  }
  .upload-btn:hover {
    background: #cc0000;
  }
  .sort-container {
    margin-bottom: 1rem;
  }
  select {
    padding: 0.4rem;
    background: #222;
    color: white;
    border-radius: 5px;
    border: 1px solid #444;
  }
  .video-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(280px,1fr));
    gap: 1rem;
    width: 100%;
    max-width: 1000px;
  }
  .video-card {
    background: #1e1e1e;
    border-radius: 10px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  video {
    width: 100%;
    height: auto;
    background: black;
  }
  .video-info {
    padding: 0.8rem;
  }
  .video-title {
    font-weight: bold;
    margin-bottom: 0.4rem;
  }
  .video-desc {
    font-size: 0.9rem;
    color: #ccc;
    margin-bottom: 0.6rem;
  }
  .video-actions {
    display: flex;
    gap: 0.5rem;
  }
  .btn {
    flex: 1;
    padding: 0.4rem;
    background: #333;
    color: white;
    border: none;
    cursor: pointer;
    border-radius: 5px;
  }
  .btn:hover {
    background: #555;
  }
  .liked {
    background: #ffdd00;
    color: black;
  }
  .fav {
    background: #ff0000;
  }
</style>
</head>
<body>

  <div class="soan-container">
    Soan
    <div class="stars">
      <span class="star">★</span>
      <span class="star">★</span>
      <span class="star">★</span>
      <span class="star">★</span>
      <span class="star">★</span>
    </div>
  </div>

  <div class="sort-container">
    <label for="sort">Trier par : </label>
    <select id="sort">
      <option value="title">Titre</option>
      <option value="likes">Likes</option>
      <option value="fav">Favoris</option>
    </select>
  </div>

  <div class="video-grid" id="videoGrid"></div>

  <button class="upload-btn" id="uploadBtn">+</button>
  <input type="file" id="fileInput" accept="video/*" style="display:none" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
  <script>
    const SUPABASE_URL = 'https://yxlzzduvuqcrrwqwmngz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bHp6ZHV2dXFjcnJ3cXdtbmd6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MDU4MTgsImV4cCI6MjA3MDQ4MTgxOH0.53JEyXxF9paOCRHSOvdzGz9Gr0cubEB7mPuhvlDqwk8';

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const videoGrid = document.getElementById('videoGrid');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const sortSelect = document.getElementById('sort');

    let videos = [];

    async function fetchVideos() {
      const { data, error } = await supabase.storage.from('videos').list('', { limit: 100 });
      if (error) {
        alert('Erreur récupération vidéos : ' + error.message);
        return;
      }
      videos = data.map(file => ({
        title: file.name,
        desc: '',
        url: supabase.storage.from('videos').getPublicUrl(file.name).data.publicUrl,
        likes: 0,
        liked: false,
        fav: false
      }));
    }

    function saveVideos() {
      localStorage.setItem('videosMeta', JSON.stringify(videos));
    }

    function loadVideosMeta() {
      const meta = localStorage.getItem('videosMeta');
      if (meta) {
        videos = JSON.parse(meta);
      }
    }

    function renderVideos() {
      videoGrid.innerHTML = '';
      let sorted = [...videos];
      if (sortSelect.value === 'title') {
        sorted.sort((a,b) => a.title.localeCompare(b.title));
      } else if (sortSelect.value === 'likes') {
        sorted.sort((a,b) => b.likes - a.likes);
      } else if (sortSelect.value === 'fav') {
        sorted.sort((a,b) => (b.fav ? 1 : 0) - (a.fav ? 1 : 0));
      }
      sorted.forEach(vid => {
        const card = document.createElement('div');
        card.className = 'video-card';
        const videoEl = document.createElement('video');
        videoEl.src = vid.url;
        videoEl.controls = true;
        const info = document.createElement('div');
        info.className = 'video-info';
        const title = document.createElement('div');
        title.className = 'video-title';
        title.textContent = vid.title;
        const desc = document.createElement('div');
        desc.className = 'video-desc';
        desc.textContent = vid.desc;
        const actions = document.createElement('div');
        actions.className = 'video-actions';
        const likeBtn = document.createElement('button');
        likeBtn.className = 'btn' + (vid.liked ? ' liked' : '');
        likeBtn.textContent = `👍 ${vid.likes}`;
        likeBtn.onclick = () => {
          vid.liked = !vid.liked;
          vid.likes += vid.liked ? 1 : -1;
          saveVideos();
          renderVideos();
        };
        const favBtn = document.createElement('button');
        favBtn.className = 'btn' + (vid.fav ? ' fav' : '');
        favBtn.textContent = '★';
        favBtn.onclick = () => {
          vid.fav = !vid.fav;
          saveVideos();
          renderVideos();
        };
        actions.appendChild(likeBtn);
        actions.appendChild(favBtn);
        info.appendChild(title);
        info.appendChild(desc);
        info.appendChild(actions);
        card.appendChild(videoEl);
        card.appendChild(info);
        videoGrid.appendChild(card);
      });
    }

    uploadBtn.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', async e => {
      const file = e.target.files[0];
      if (!file) return;

      const title = prompt('Titre de la vidéo :') || file.name;
      const desc = prompt('Description :') || '';

      const filePath = `${Date.now()}_${file.name}`;

      const { data, error } = await supabase.storage.from('videos').upload(filePath, file, {
        cacheControl: '3600',
        upsert: false
      });

      if (error) {
        alert('Erreur upload : ' + error.message);
        return;
      }

      const { publicUrl } = supabase.storage.from('videos').getPublicUrl(filePath).data;

      videos.push({
        title,
        desc,
        url: publicUrl,
        likes: 0,
        liked: false,
        fav: false
      });
      saveVideos();
      renderVideos();
    });

    sortSelect.addEventListener('change', renderVideos);

    (async () => {
      loadVideosMeta();
      await fetchVideos();
      // Fusion des métadonnées locales (likes, fav, desc) dans les vidéos récupérées
      const localMeta = JSON.parse(localStorage.getItem('videosMeta') || '[]');
      videos = videos.map(v => {
        const meta = localMeta.find(m => m.url === v.url);
        return meta ? { ...v, likes: meta.likes, liked: meta.liked, fav: meta.fav, desc: meta.desc || v.desc } : v;
      });
      saveVideos();
      renderVideos();
    })();
  </script>

</body>
</html>
