<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Soan - Upload vidéos avec erreurs</title>
<style>
  /* Styles inchangés sauf ajout d'overlay d'erreur */
  body {
    margin: 0;
    background: #121212;
    color: #fff;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
    min-height: 100vh;
  }
  .soan-container {
    position: relative;
    font-size: 3rem;
    font-weight: 900;
    color: #ffdd00;
    text-transform: uppercase;
    letter-spacing: 0.3em;
    margin: 1rem 0 2rem;
    user-select: none;
  }
  .stars {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 200%;
    height: 200%;
    pointer-events: none;
    transform: translate(-50%, -50%);
    z-index: -1;
  }
  .star {
    position: absolute;
    color: #fff;
    font-size: 1.2rem;
    animation: twinkle 3s infinite ease-in-out;
    filter: drop-shadow(0 0 3px #fff);
  }
  .star:nth-child(1) { top: 10%; left: 20%; animation-delay: 0s; }
  .star:nth-child(2) { top: 30%; left: 70%; animation-delay: 1s; }
  .star:nth-child(3) { top: 60%; left: 50%; animation-delay: 2s; }
  .star:nth-child(4) { top: 75%; left: 15%; animation-delay: 1.5s; }
  .star:nth-child(5) { top: 40%; left: 80%; animation-delay: 0.7s; }
  @keyframes twinkle {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }
  .sort-container {
    margin-bottom: 1rem;
  }
  select {
    padding: 0.4rem;
    background: #222;
    color: white;
    border-radius: 5px;
    border: 1px solid #444;
    font-size: 1rem;
  }
  .video-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(280px,1fr));
    gap: 1rem;
    width: 100%;
    max-width: 1000px;
    margin-bottom: 6rem;
  }
  .video-card {
    background: #1e1e1e;
    border-radius: 10px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  video {
    width: 100%;
    height: auto;
    background: black;
    border-bottom: 1px solid #333;
  }
  .video-info {
    padding: 0.8rem;
  }
  .video-title {
    font-weight: bold;
    margin-bottom: 0.4rem;
    font-size: 1.1rem;
    word-break: break-word;
  }
  .video-desc {
    font-size: 0.9rem;
    color: #ccc;
    margin-bottom: 0.6rem;
    min-height: 40px;
    word-break: break-word;
  }
  .video-actions {
    display: flex;
    gap: 0.5rem;
  }
  .btn {
    flex: 1;
    padding: 0.4rem;
    background: #333;
    color: white;
    border: none;
    cursor: pointer;
    border-radius: 5px;
    font-size: 1rem;
    transition: background-color 0.3s ease;
    user-select: none;
  }
  .btn:hover {
    background: #555;
  }
  .liked {
    background: #ffdd00;
    color: black;
  }
  .fav {
    background: #ff0000;
  }
  #uploadLabel {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #ff0000;
    width: 70px;
    height: 70px;
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(255,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    color: white;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
  }
  #uploadLabel:hover {
    background: #cc0000;
    box-shadow: 0 6px 20px rgba(204,0,0,0.9);
  }
  #uploadLabel::after {
    content: "Uploader une vidéo";
    position: absolute;
    bottom: 90px;
    right: 0;
    background: #222;
    color: #ff0000;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 1rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    white-space: nowrap;
  }
  #uploadLabel:hover::after {
    opacity: 1;
  }
  #fileInput {
    display: none;
  }
  #loaderOverlay {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ff0000;
    font-size: 2rem;
    font-weight: 900;
    user-select: none;
    z-index: 9999;
    display: none;
  }
  #errorOverlay {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(255,0,0,0.85);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 10px;
    font-weight: 700;
    font-size: 1rem;
    user-select: none;
    box-shadow: 0 4px 15px rgba(255,0,0,0.9);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease;
    z-index: 10000;
    max-width: 320px;
  }
  #errorOverlay.show {
    opacity: 1;
    pointer-events: auto;
  }
</style>
</head>
<body>

  <div class="soan-container">
    Soan
    <div class="stars">
      <span class="star">★</span>
      <span class="star">★</span>
      <span class="star">★</span>
      <span class="star">★</span>
      <span class="star">★</span>
    </div>
  </div>

  <div class="sort-container">
    <label for="sort">Trier par : </label>
    <select id="sort">
      <option value="title">Titre</option>
      <option value="likes">Likes</option>
      <option value="fav">Favoris</option>
    </select>
  </div>

  <div class="video-grid" id="videoGrid"></div>

  <label id="uploadLabel" for="fileInput" title="Uploader une vidéo">+</label>
  <input type="file" id="fileInput" accept="video/*" />

  <div id="loaderOverlay">Upload en cours...</div>
  <div id="errorOverlay"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
  <script>
    const SUPABASE_URL = 'https://yxlzzduvuqcrrwqwmngz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bHp6ZHV2dXFjcnJ3cXdtbmd6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MDU4MTgsImV4cCI6MjA3MDQ4MTgxOH0.53JEyXxF9paOCRHSOvdzGz9Gr0cubEB7mPuhvlDqwk8';

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const videoGrid = document.getElementById('videoGrid');
    const fileInput = document.getElementById('fileInput');
    const loader = document.getElementById('loaderOverlay');
    const sortSelect = document.getElementById('sort');
    const errorOverlay = document.getElementById('errorOverlay');

    let videos = [];

    function showError(message) {
      errorOverlay.textContent = message;
      errorOverlay.classList.add('show');
      setTimeout(() => {
        errorOverlay.classList.remove('show');
      }, 5000);
    }

    async function fetchVideos() {
      try {
        const { data, error } = await supabase.storage.from('videos').list('', { limit: 100 });
        if (error) {
          showError(`Erreur fetch vidéos: ${error.message}`);
          return [];
        }
        const publicVideos = data.map(file => {
          const { data: urlData } = supabase.storage.from('videos').getPublicUrl(file.name);
          return {
            title: file.name,
            desc: '',
            url: urlData.publicUrl,
            likes: 0,
            liked: false,
            fav: false
          };
        });
        return publicVideos;
      } catch (err) {
        showError(`Erreur réseau fetch vidéos : ${err.message}`);
        return [];
      }
    }

    function saveVideos() {
      try {
        localStorage.setItem('videosMeta', JSON.stringify(videos));
      } catch (err) {
        showError("Erreur stockage local : " + err.message);
      }
    }

    function loadVideosMeta() {
      try {
        const meta = localStorage.getItem('videosMeta');
        return meta ? JSON.parse(meta) : [];
      } catch (err) {
        showError("Erreur lecture stockage local : " + err.message);
        return [];
      }
    }

    function renderVideos() {
      videoGrid.innerHTML = '';
      let sorted = [...videos];
      if (sortSelect.value === 'title') {
        sorted.sort((a,b) => a.title.localeCompare(b.title));
      } else if (sortSelect.value === 'likes') {
        sorted.sort((a,b) => b.likes - a.likes);
      } else if (sortSelect.value === 'fav') {
        sorted.sort((a,b) => (b.fav ? 1 : 0) - (a.fav ? 1 : 0));
      }
      sorted.forEach(vid => {
        const card = document.createElement('div');
        card.className = 'video-card';
        const videoEl = document.createElement('video');
        videoEl.src = vid.url;
        videoEl.controls = true;
        videoEl.preload = "metadata";
        videoEl.title = vid.title;
        const info = document.createElement('div');
        info.className = 'video-info';
        const title = document.createElement('div');
        title.className = 'video-title';
        title.textContent = vid.title;
        const desc = document.createElement('div');
        desc.className = 'video-desc';
        desc.textContent = vid.desc;
        const actions = document.createElement('div');
        actions.className = 'video-actions';

        const likeBtn = document.createElement('button');
        likeBtn.className = 'btn' + (vid.liked ? ' liked' : '');
        likeBtn.textContent = `👍 ${vid.likes}`;
        likeBtn.onclick = () => {
          vid.liked = !vid.liked;
          vid.likes += vid.liked ? 1 : -1;
          saveVideos();
          renderVideos();
        };

        const favBtn = document.createElement('button');
        favBtn.className = 'btn' + (vid.fav ? ' fav' : '');
        favBtn.textContent = '★';
        favBtn.onclick = () => {
          vid.fav = !vid.fav;
          saveVideos();
          renderVideos();
        };

        actions.appendChild(likeBtn);
        actions.appendChild(favBtn);
        info.appendChild(title);
        info.appendChild(desc);
        info.appendChild(actions);

        card.appendChild(videoEl);
        card.appendChild(info);
        videoGrid.appendChild(card);
      });
    }

    fileInput.addEventListener('click', e => {
      const code = prompt("Entrez le code d'accès pour uploader :", "");
      if (code !== '2012') {
        showError('Code incorrect, upload annulé.');
        e.preventDefault();
        fileInput.blur();
        return false;
      }
    });

    fileInput.addEventListener('change', async e => {
      const file = e.target.files[0];
      if (!file) return;

      const title = prompt('Titre de la vidéo :', file.name) || file.name;
      const desc = prompt('Description :', '') || '';

      const filePath = `${Date.now()}_${file.name}`;

      loader.style.display = 'flex';

      try {
        const { data, error } = await supabase.storage.from('videos').upload(filePath, file, {
          cacheControl: '3600',
          upsert: false
        });

        loader.style.display = 'none';

        if (error) {
          showError(`Erreur upload : ${error.message}`);
          return;
        }

        const { data: urlData } = supabase.storage.from('videos').getPublicUrl(filePath);

        if(!urlData.publicUrl) {
          showError('Erreur: URL publique introuvable après upload.');
          return;
        }

        videos.push({
          title,
          desc,
          url: urlData.publicUrl,
          likes: 0,
          liked: false,
          fav: false
        });
        saveVideos();
        renderVideos();
      } catch (err) {
        loader.style.display = 'none';
        showError('Erreur réseau lors de l’upload : ' + err.message);
      }

      fileInput.value = '';
    });

    sortSelect.addEventListener('change', renderVideos);

    (async () => {
      try {
        const localMeta = loadVideosMeta();
        const onlineVideos = await fetchVideos();

        videos = onlineVideos.map(v => {
          const local = localMeta.find(m => m.url === v.url);
          return local ? { ...v, likes: local.likes, liked: local.liked, fav: local.fav, desc: local.desc || v.desc } : v;
        });

        saveVideos();
        renderVideos();
      } catch (err) {
        showError('Erreur initialisation : ' + err.message);
      }
    })();
  </script>

</body>
</html>
